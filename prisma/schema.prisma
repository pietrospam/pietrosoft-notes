generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Client {
  id          String    @id
  name        String
  description String?
  color       String?   // REQ-008.3: Client color (hex code)
  active      Boolean   @default(true)
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  notes       Note[]    @relation("ClientNotes")
  projects    Project[]

  @@map("clients")
}

model Project {
  id          String   @id
  name        String
  description String?
  clientId    String   @map("client_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  notes       Note[]   @relation("ProjectNotes")
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@map("projects")
}

model Note {
  id                    String          @id
  type                  NoteType
  title                 String
  content               String?
  projectId             String?         @map("project_id")
  clientId              String?         @map("client_id")
  archived              Boolean         @default(false)
  isFavorite            Boolean         @default(false) @map("is_favorite")
  favoriteOrder         Int?            @map("favorite_order") // REQ-008.2: Position in favorites
  attachments           Json?
  taskStatus            TaskStatus?     @map("task_status")
  taskPriority          TaskPriority?   @map("task_priority")
  taskDueDate           DateTime?       @map("task_due_date")
  connectionUrl         String?         @map("connection_url")
  connectionCredentials String?         @map("connection_credentials")
  timesheetDate         DateTime?       @map("timesheet_date")
  timesheetHours        Float?          @map("timesheet_hours")
  timesheetRate         Float?          @map("timesheet_rate")
  timesheetState        TimesheetState? @default(DRAFT) @map("timesheet_state")
  timesheetTaskId       String?         @map("timesheet_task_id")
  createdAt             DateTime        @default(now()) @map("created_at")
  updatedAt             DateTime        @updatedAt @map("updated_at")
  contentJson           Json?           @map("content_json")
  taskTicketPhaseCode   String?         @map("task_ticket_phase_code")
  taskShortDescription  String?         @map("task_short_description")
  taskBudgetHours       Float?          @map("task_budget_hours")
  client                Client?         @relation("ClientNotes", fields: [clientId], references: [id])
  project               Project?        @relation("ProjectNotes", fields: [projectId], references: [id])
  timesheetTask         Note?           @relation("TaskTimesheets", fields: [timesheetTaskId], references: [id])
  timesheets            Note[]          @relation("TaskTimesheets")
  attachmentFiles       Attachment[]    // REQ-007: Relation to attachment files

  @@index([type])
  @@index([projectId])
  @@index([clientId])
  @@index([archived])
  @@index([isFavorite])
  @@index([timesheetTaskId])
  @@map("notes")
}

enum NoteType {
  GENERAL
  TASK
  CONNECTION
  TIMESHEET
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum TimesheetState {
  DRAFT
  FINAL
}

// REQ-007: Attachments stored in database as BLOB
model Attachment {
  id           String   @id @default(uuid())
  noteId       String   @map("note_id")
  filename     String   @db.VarChar(255)
  originalName String   @map("original_name") @db.VarChar(255)
  mimeType     String   @map("mime_type") @db.VarChar(100)
  size         Int
  data         Bytes
  createdAt    DateTime @default(now()) @map("created_at")

  note         Note     @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@index([noteId])
  @@map("attachments")
}
